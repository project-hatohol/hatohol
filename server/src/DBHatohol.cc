/*
 * Copyright (C) 2014-2015 Project Hatohol
 *
 * This file is part of Hatohol.
 *
 * Hatohol is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License, version 3
 * as published by the Free Software Foundation.
 *
 * Hatohol is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with Hatohol. If not, see
 * <http://www.gnu.org/licenses/>.
 */

#include "DBHatohol.h"
#include "ConfigManager.h"
#include "DBTablesConfig.h"
#include "DBTablesHost.h" 
#include "DBTablesUser.h"
#include "DBTablesAction.h"
#include "DBTablesMonitoring.h"
#include "DBTablesLastInfo.h"

using namespace std;

static const char *DEFAULT_DB_NAME = "hatohol";
static const char *DEFAULT_USER_NAME = "hatohol";
static const char *DEFAULT_PASSWORD  = "hatohol";

struct DBTablesMajorVersionChecker {
	DBTablesMajorVersionChecker(DBAgent &dbAgent)
	{
		DBTables::checkMajorVersion<DBTablesConfig>(dbAgent);
		DBTables::checkMajorVersion<DBTablesHost>(dbAgent);
		DBTables::checkMajorVersion<DBTablesUser>(dbAgent);
		DBTables::checkMajorVersion<DBTablesAction>(dbAgent);
		DBTables::checkMajorVersion<DBTablesMonitoring>(dbAgent);
		DBTables::checkMajorVersion<DBTablesLastInfo>(dbAgent);
	}
};

struct DBHatohol::Impl {
	static SetupContext setupCtx;

	DBTablesMajorVersionChecker verChecker;
	DBTablesConfig  dbTablesConfig;
	DBTablesHost    dbTablesHost;
	DBTablesUser    dbTablesUser;
	DBTablesAction  dbTablesAction;
	DBTablesMonitoring dbTablesMonitoring;
	DBTablesLastInfo dbTablesLastInfo;

	Impl(DBAgent &dbAgent)
	: verChecker(dbAgent),
	  dbTablesConfig(dbAgent),
	  dbTablesHost(dbAgent),
	  dbTablesUser(dbAgent),
	  dbTablesAction(dbAgent),
	  dbTablesMonitoring(dbAgent),
	  dbTablesLastInfo(dbAgent)
	{
	}
};

DB::SetupContext DBHatohol::Impl::setupCtx(typeid(DBHatohol));

// ---------------------------------------------------------------------------
// This function is intended to call from hatohol-db-initiator
// ---------------------------------------------------------------------------
extern "C"
int createDBHatohol(
  const char *dbName, const char *user, const char *password)
{
	try {
		DBHatohol::setDefaultDBParams(dbName, user, password);
		DBHatohol db; // Create all DBTables instances to create tables
	} catch (...) {
		return -1;
	}
	return 0;
}

// ---------------------------------------------------------------------------
// Public methods
// ---------------------------------------------------------------------------
void DBHatohol::reset(void)
{
	Impl::setupCtx.initialized = false;
	DBConnectInfo &connInfo = Impl::setupCtx.connectInfo;

	ConfigManager *confMgr = ConfigManager::getInstance();
	connInfo.host = confMgr->getDBServerAddress();
	connInfo.port = confMgr->getDBServerPort();

	connInfo.user     = DEFAULT_USER_NAME;
	connInfo.password = DEFAULT_PASSWORD;
	connInfo.dbName   = DEFAULT_DB_NAME;
}

void DBHatohol::setDefaultDBParams(
  const char *dbName, const char *user, const char *password)
{
	DBConnectInfo &connInfo = Impl::setupCtx.connectInfo;
	if (dbName)
		connInfo.dbName   = dbName;
	if (user)
		connInfo.user     = user;
	if (password)
		connInfo.password = password;
}

DBHatohol::DBHatohol(void)
: DB(Impl::setupCtx),
  m_impl(new Impl(getDBAgent()))
{
}

DBHatohol::~DBHatohol()
{
}

DBTablesConfig &DBHatohol::getDBTablesConfig(void)
{
	return m_impl->dbTablesConfig;
}

DBTablesHost &DBHatohol::getDBTablesHost(void)
{
	return m_impl->dbTablesHost;
}

DBTablesUser &DBHatohol::getDBTablesUser(void)
{
	return m_impl->dbTablesUser;
}

DBTablesAction &DBHatohol::getDBTablesAction(void)
{
	return m_impl->dbTablesAction;
}

DBTablesMonitoring &DBHatohol::getDBTablesMonitoring(void)
{
	return m_impl->dbTablesMonitoring;
}

DBTablesLastInfo &DBHatohol::getDBTablesLastInfo(void)
{
	return m_impl->dbTablesLastInfo;
}
