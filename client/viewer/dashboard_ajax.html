{% extends "viewer/base_ajax.html" %}
{% load i18n %}

{% comment %}
  Copyright (C) 2013 Project Hatohol

  This file is part of Hatohol.

  Hatohol is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 2 of the License, or
  (at your option) any later version.

  Hatohol is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Hatohol. If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}

{% block refresh %}
    <meta http-equiv="refresh" content="60">
{% endblock %}

{% block main %}
  <h2>{% trans "Dashboard" %}</h2>

  {# Total servers count #}
  {# Good server status #}
  <table class="table table-condensed table-striped table-hover" id="tblServer">
    <thead>
      <tr>
        <th colspan='2'>{% trans "Parameter" %}</th>
        <th>{% trans "Value" %}</th>
        <th>　　　　</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  {# Bad server reason #}

  <hr />

  {# System status #}
  <table class="table table-condensed table-striped table-hover" id="tblTrigger">
    <thead>
      <tr>
        <th>{% trans "Server" %}</th>
        <th>{% trans "Group" %}</th>
        <th>{% trans "Disaster" %}</th>
        <th>{% trans "High" %}</th>
        <th>{% trans "Average" %}</th>
        <th>{% trans "Warning" %}</th>
        <th>{% trans "Information" %}</th>
        <th>{% trans "Not classified" %}</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <hr />

  {# Host status #}
  <table class="table table-condensed table-striped table-hover" id="tblHost">
    <thead>
      <tr>
        <th>{% trans "Server" %}</th>
        <th>{% trans "Group" %}</th>
        <th>{% trans "Without problems" %}</th>
        <th>{% trans "With problems" %}</th>
        <th>{% trans "Total" %}</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

{% endblock %}

{% block logic %}
  <script type="text/javascript">

    function parseData(replyData) {
      var parsedData = {};
      var serverStatus, hostStatus, systemStatus;
      var x, y;
      var serverId, groupId, severity, numberOfHosts;

      for (x = 0; x < replyData["serverStatus"].length; ++x) {
        serverStatus = replyData["serverStatus"][x];
        serverId = serverStatus["serverId"];
        parsedData[serverId] = {};

        parsedData[serverId]["goodHosts"] = 0;
        parsedData[serverId]["badHosts"]  = 0;
        for (y = 0; y < serverStatus["hostStatus"].length; ++y) {
          hostStatus = serverStatus["hostStatus"][y];
          parsedData[serverId]["goodHosts"] += hostStatus["numberOfGoodHosts"];
          parsedData[serverId]["badHosts"]  += hostStatus["numberOfBadHosts"];
        }

        parsedData[serverId]["numberOfHostGroups"] = 0;
        for (y in serverStatus["hostGroups"])
          parsedData[serverId]["numberOfHostGroups"] += 1;

        parsedData[serverId]["problem"] = 0;
        for (y = 0; y < serverStatus["systemStatus"].length; ++y) {
          systemStatus = serverStatus["systemStatus"][y];
          groupId = systemStatus["hostGroupId"];
          if (!(groupId in parsedData[serverId]))
            parsedData[serverId][groupId] = {};
          severity = systemStatus["severity"];
          numberOfHosts = systemStatus["numberOfHosts"];
          parsedData[serverId][groupId][severity] = numberOfHosts;
          parsedData[serverId]["problem"] += numberOfHosts;
        }
      }

      return parsedData;
    }

    function buildProgress(bad, total) {
      var html = "";
      var bad_ratio;

      bad_ratio = (100 * bad / total) << 0;

      html += "<div class='progress'>";
      html += "<div class='bar bar-success' style='width:" + (100 - bad_ratio) + "%;'></div>";
      html += "<div class='bar bar-danger'  style='width:" +        bad_ratio  + "%;'></div>";
      html += "</div>";

      return html;
    }

    function buildRatioColumns(numerator, denominator) {
      var html = "";
      html += "<td>" + numerator + " / " + denominator + "</td>";
      html += "<td>" + buildProgress(numerator, denominator) + "</td>";
      return html;
    }

    function drawServerBody(replyData, parsedData) {
      var html = "";
      var serverStatus;
      var x;
      var goods, bads;
      var serverId;

      goods = replyData["serverStatus"];
      bads  = replyData["badServers"];

      html += "<tr>";
      html += "<td colspan='2'>{% trans "Number of servers [With problem]" %}</td>";
      html += buildRatioColumns(bads.length, replyData["numberOfServers"]);
      html += "</tr>";

      for (x = 0; x < goods.length; ++x) {
        serverStatus = goods[x];
        serverId = serverStatus["serverId"];
        html += "<tr>";
        html += "<td rowspan='5'>" + serverStatus["serverNickname"] + "</td>";
        html += "<td>{% trans "Number of hosts [with problem]" %}</td>";
        html += buildRatioColumns(parsedData[serverId]["badHosts"],
                                  serverStatus["numberOfHosts"]);
        html += "</tr>";
        html += "<tr>";
        html += "<td>{% trans "Number of items" %}</td>";
        html += "<td>" + serverStatus["numberOfItems"] + "</td>";
        html += "<td></td>";
        html += "</tr>";
        html += "<tr>";
        html += "<td>{% trans "Number of triggers [with problem]" %}</td>";
        html += buildRatioColumns(parsedData[serverId]["problem"],
                                  serverStatus["numberOfTriggers"]);
        html += "</tr>";
        html += "<tr>";
        html += "<td>{% trans "Number of users [Online]" %}</td>";
        html += buildRatioColumns(serverStatus["numberOfOnlineUsers"],
                                  serverStatus["numberOfUsers"]);
        html += "</tr>";
        html += "<tr>";
        html += "<td>{% trans "New values per second" %}</td>";
        html += "<td>" + serverStatus["numberOfMonitoredItemsPerSecond"] + "</td>";
        html += "<td></td>";
        html += "</tr>";
      }

      return html;
    }

    function drawTriggerBody(replyData, parsedData) {
      var html = "";
      var x, y, severity;
      var serverId, groupId, numberOfHosts;

      for (x = 0; x < replyData["serverStatus"].length; ++x) {
        serverId = replyData["serverStatus"][x]["serverId"];
        html += "<tr>";
        y = 0;
        for (groupId in replyData["serverStatus"][x]["hostGroups"]) {
          if (y == 0) {
            html += "<td rowspan='" + parsedData[serverId]["numberOfHostGroups"] + "'>";
            html += replyData["serverStatus"][x]["serverNickname"];
            html += "</td>";
          }
          html += "<td>";
          html += replyData["serverStatus"][x]["hostGroups"][groupId]["name"];
          html += "</td>";
          for (severity = 5; severity >= 0; --severity) {
            numberOfHosts = parsedData[serverId][groupId][severity];
            if (isNaN(numberOfHosts))
              numberOfHosts = 0;
            html += "<td>" + numberOfHosts + "</td>";
          }
          ++y;
        }
        html += "</tr>";
      }

      return html;
    }

    function drawHostBody(replyData, parsedData) {
      var html = "";
      var serverStatus, hostStatuses, hostStatus;
      var x, y;

      for (x = 0; x < replyData["serverStatus"].length; ++x) {
        serverStatus = replyData["serverStatus"][x];
        hostStatuses = replyData["serverStatus"][x]["hostStatus"];
        html += "<tr>";
        for (y = 0; y < hostStatuses.length; ++y) {
          hostStatus = hostStatuses[y];
          if (y == 0) {
            html += "<td rowspan='" + hostStatuses.length + "'>";
            html += replyData["serverStatus"][x]["serverNickname"];
            html += "</td>";
          }
          html += "<td>";
          html += serverStatus["hostGroups"][hostStatus["hostGroupId"]]["name"];
          html += "</td>";
          html += "<td>";
          html += hostStatus["numberOfGoodHosts"];
          html += "</td>";
          html += "<td>";
          html += hostStatus["numberOfBadHosts"];
          html += "</td>";
          html += "<td>";
          html += hostStatus["numberOfGoodHosts"] + hostStatus["numberOfBadHosts"];
          html += "</td>";
        }
        html += "</tr>";
      }

      return html;
    }

    function updateCore(reply) {
      var rawData = reply;
      var parsedData = parseData(rawData);

      $("#tblServer tbody").empty();
      $("#tblServer tbody").append(drawServerBody(rawData, parsedData));
      $("#tblTrigger tbody").empty();
      $("#tblTrigger tbody").append(drawTriggerBody(rawData, parsedData));
      $("#tblHost tbody").empty();
      $("#tblHost tbody").append(drawHostBody(rawData, parsedData));
    }

    userProfile.addOnLoadCb(function() {
      startConnection('overview', updateCore);
    });
  </script>
{% endblock %}
