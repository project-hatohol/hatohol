{% extends "viewer/base_ajax.html" %}
{% load i18n %}

{% comment %}
  Copyright (C) 2013 Project Hatohol

  This file is part of Hatohol.

  Hatohol is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 2 of the License, or
  (at your option) any later version.

  Hatohol is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with Hatohol. If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}

{% block main %}
  <h2>{% trans "Users" %}</h2>

  <form class="form-inline">
    <input id="add-user-button" type="button" class="btn"
     value="{% trans "ADD USER" %}" style="display: none;" />
    <input id="delete-user-button" type="button" class="btn" disabled
     value="{% trans "DELETE USER" %}" style="display: none;" />
    <input id="edit-user-roles-button" type="button" class="btn"
     value="{% trans "EDIT USER ROLES" %}" style="display: none;" />
  </form>

  <div id="msgbox" title="Message Box">
    <p id="msgbox-text"></p>
  </div>

  <form id="add-user-form", method="POST"> {% csrf_token %}
  </form>

  <table class="table table-condensed table-striped table-hover" id="table">
    <thead>
      <tr>
        <th class="delete-selector" style='display:none;'>  </th>
        <th data-sort="int">{% trans "ID" %}</th>
        <th data-sort="string">{% trans "User name" %}</th>
        <th data-sort="string">{% trans "User type" %}</th>
        <th data-sort="string" class="privilege-column" style="display:none;">{% trans "Privileges" %}</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
{% endblock %}

{% block option %}
  <script src="{{ STATIC_URL }}js/hatohol_user_edit_dialog.js"></script>
  <script src="{{ STATIC_URL }}js/hatohol_privilege_edit_dialog.js"></script>
  <script src="{{ STATIC_URL }}js/hatohol_user_roles_editor.js"></script>
{% endblock %}

{% block logic %}
  <script type="text/javascript">
    //
    // Variables
    //
    var numSelected = 0;

    //
    // Main view
    //
    $("#table").stupidtable();
    $("#table").bind('aftertablesort', function(event, data) {
      var th = $(this).find("th");
      th.find("i.sort").remove();
      var icon = data.direction === "asc" ? "up" : "down";
      th.eq(data.column).append("<i class='sort icon-arrow-" + icon +"'></i>");
    });

    $("#add-user-button").click(function() {
      new HatoholUserEditDialog({
        operator: userProfile.user,
        succeededCallback: addOrEditSucceededCb
      });
    });

    $("#delete-user-button").click(function() {
      var msg = "{% trans "Do you delete the selected items ?" %}";
      hatoholNoYesMsgBox(msg, deleteUsers);
    });

    function addOrEditSucceededCb() {
      startConnection('user', updateCore);
    }

    //
    // Event handlers for forms in the main view
    //
    function setupCheckboxHandler() {
      $(".selectcheckbox").change(function() {
        var check = $(this).is(":checked");
        var prevNumSelected = numSelected;
        if (check)
          numSelected += 1;
        else
          numSelected -= 1;
         if (prevNumSelected == 0 && numSelected == 1)
          $("#delete-user-button").attr("disabled", false);
        else if (prevNumSelected == 1 && numSelected == 0)
          $("#delete-user-button").attr("disabled", true);
      });

      if (hasFlag(userProfile.user, hatohol.OPPRVLG_DELETE_USER)) {
        $(".delete-selector").show();
      }
    }

    function setupEditLinksAndButtons(reply)
    {
      var i, id, users = reply["users"], usersMap = {}, userId;
      for (i = 0; i < users.length; ++i) {
        usersMap[users[i]["userId"]] = users[i];
      }

      for (i = 0; i < users.length; ++i) {
        id = "#edit-user" + users[i]["userId"];
        $(id).click(function() {
          var userId = this.getAttribute("userId");
          new HatoholUserEditDialog({
            operator: userProfile.user,
            succeededCallback: addOrEditSucceededCb,
            targetUser: usersMap[userId]
          });
        });

        id = id + "-privileges";
        $(id).click(function() {
          var userId = this.getAttribute("userId");
          new HatoholPrivilegeEditDialog(userId, applyPrivilegesCb);
        });
      }

      if (hasFlag(userProfile.user, hatohol.OPPRVLG_UPDATE_USER)) {
        $(".privilege-column").show();
      }
    }

    function applyPrivilegesCb() {
      startConnection('user', updateCore);
    }

    //
    // Commonly used functions from a dialog.
    //

    //
    // delete-user dialog
    //
    function deleteUsers() {
      var delId = [], userId;
      var checkbox = $(".selectcheckbox");
      $(this).dialog("close");
      for (var i = 0; i < checkbox.length; i++) {
        if (!checkbox[i].checked)
          continue;
        userId = checkbox[i].getAttribute("userId");
        delId.push(userId);
      }
      new HatoholItemRemover({
        id: delId,
        type: "user",
        completionCallback: function() {
          startConnection("user", updateCore);
        },
      });
      hatoholInfoMsgBox("{% trans "Deleting..." %}");
    }

    function getUserTypeFromFlags(flags) {
      switch(flags) {
      case hatohol.ALL_PRIVILEGES:
        return gettext("Admin");
      case hatohol.NONE_PRIVILEGE:
        return gettext("Guest");
      default:
        break;
      }
      return gettext("Unknown");
    }

    //
    // callback function from the base template
    //
    function drawTableBody(reply) {
      var i;
      var html;
      var user;

      html = "";
      for (i = 0; i < reply["users"].length; ++i) {
        user = reply["users"][i];
        html += "<tr>";
        html += "<td class='delete-selector' style='display:none;'>";
        html += "<input type='checkbox' class='selectcheckbox' userId='" + user["userId"] + "'>";
        html += "</td>";
        html += "<td>" + user["userId"] + "</td>";
        html += "<td>";
        if (hasFlag(userProfile.user, hatohol.OPPRVLG_UPDATE_USER)) {
          html += "<a href='javascript:void(0);' id='edit-user" + user["userId"];
          html += "' userId='"+ user["userId"] + "'>" + user["name"]   + "</a></td>";
        } else {
          html += user["name"];
        }
        html += "<td>" + getUserTypeFromFlags(user["flags"])  + "</td>";
        if (user["flags"] == hatohol.ALL_PRIVILEGES) {
          html += "<td class='privilege-column' style='display:none;'>"
          html += '{% trans "All" %}' + "</td>";
        } else {
          html += "<td class='privilege-column' style='display:none;'>";
          html += "<form class='form-inline' style='margin: 0'>";
          html += "  <input id='edit-user" + user["userId"] + "-privileges'";
          html += "    type='button' class='btn'";
          html += "    userId='" + user["userId"] + "'";
          html += "    value='{% trans "Show / Edit" %}' />";
          html += "</form>"
          html += "</td>";
        }
        html += "</tr>";
      }

      return html;
    }

    function updateCore(reply) {
      $("#table tbody").empty();
      $("#table tbody").append(drawTableBody(reply));
      setupCheckboxHandler();
      setupEditLinksAndButtons(reply);
      numSelected = 0;
    }

    //
    // main code
    //
    userProfile.addOnLoadCb(function(user) {
      if (hasFlag(user, hatohol.OPPRVLG_CREATE_USER))
        $("#add-user-button").show();
      if (hasFlag(user, hatohol.OPPRVLG_DELETE_USER))
        $("#delete-user-button").show();
      startConnection('user', updateCore);
    });
  </script>
{% endblock %}
